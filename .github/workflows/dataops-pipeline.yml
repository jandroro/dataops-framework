name: DataOps Pipeline â€“ Bronze to Silver (SQL-only)

on:
  workflow_dispatch: {}
  push:
    branches: ["main"]
    paths:
      - "data/**"
      - "framework/**"
      - ".github/workflows/dataops-pipeline.yml"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector

      - name: Deploy base objects (schema + bronze + ops tables)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          SQL_FILE: framework/deployment/deploy.sql
        run: |
          python framework/processing/run_sql.py

      - name: Deploy Silver v2 table (ACL-safe)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          SQL_FILE: framework/deployment/deploy_silver_v2.sql
        run: |
          python framework/processing/run_sql.py

  bronze:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector

      - name: Ingest Bronze into Databricks SQL
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          CSV_PATH: data/source/customers.csv
          TARGET_TABLE: dataops.bronze_customers
          SOURCE_NAME: github_actions
        run: |
          python framework/ingestion/ingest_bronze.py

  silver:
    runs-on: ubuntu-latest
    needs: bronze
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector

      - name: Debug silver SQL file (first 80 lines)
        run: |
          echo "PWD:"
          pwd
          echo "Repo root contents:"
          ls -la
          echo "---- framework/processing/load_silver.sql (first 80 lines) ----"
          sed -n '1,80p' framework/processing/load_silver.sql

      - name: Load Silver (forced v2)
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          SQL_FILE: framework/processing/load_silver.sql
          SILVER_TABLE: dataops.silver_customers_v2
        run: |
          python framework/processing/run_sql.py

  validation:
    runs-on: ubuntu-latest
    needs: silver
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install databricks-sql-connector

      - name: Validate Silver v2 + write ops_dq_results
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          RUN_ID: ${{ github.run_id }}
          SILVER_TABLE: dataops.silver_customers_v2
        run: |
          python framework/validation/validate_silver.py

  tests:
    runs-on: ubuntu-latest
    needs: validation
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run basic dataset tests
        run: |
          python framework/tests/test_dataset.py
  
  monitoring:
   runs-on: ubuntu-latest
   needs: validation
   if: always()
   steps:
     - name: Checkout repository
       uses: actions/checkout@v4

     - name: Setup Python
       uses: actions/setup-python@v5
       with:
         python-version: "3.11"

     - name: Install dependencies
       run: |
         python -m pip install --upgrade pip
         pip install databricks-sql-connector

     - name: Log pipeline event to ops_event_log
       env:
         DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
         DATABRICKS_HTTP_PATH: ${{ secrets.DATABRICKS_HTTP_PATH }}
         DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
         SQL_FILE: framework/monitoring/log_event.sql
         RUN_ID: ${{ github.run_id }}
         STAGE: "pipeline"
         STATUS: ${{ job.status }}
         DETAILS: "Bronze->Silver pipeline finished. deploy=${{ needs.deploy.result }}, bronze=${{ needs.bronze.result }}, silver=${{ needs.silver.result }}, validation=${{ needs.validation.result }}"
       run: |
         python framework/processing/run_sql.py
